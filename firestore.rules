rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ⚠️ ========================================
    // ⚠️ RÈGLES TEMPORAIRES POUR MIGRATION
    // ⚠️ ========================================
    // ⚠️ À REMPLACER par les règles complètes après la migration !
    // ⚠️ Ces règles permettent à tout utilisateur authentifié de lire/écrire partout
    
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // ========================================
    // RÈGLES COMPLÈTES (À DÉCOMMENTER APRÈS MIGRATION)
    // ========================================
    /*
    
    // ========================================
    // PLATFORM SETTINGS (Super Admin only)
    // ========================================
    match /platformSettings/{document=**} {
      allow read: if isAuthenticated() && isSuperAdmin();
      allow write: if isAuthenticated() && isSuperAdmin();
    }
    
    // ========================================
    // PLATFORM ADMINS (Super Admin only)
    // ========================================
    match /platformAdmins/{adminId} {
      allow read: if isAuthenticated() && isSuperAdmin();
      allow write: if isAuthenticated() && isSuperAdmin();
    }
    
    // ========================================
    // ORGANIZATIONS
    // ========================================
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && (belongsToOrg(orgId) || isSuperAdmin());
      allow write: if isAuthenticated() && (isOrgAdmin(orgId) || isSuperAdmin());
      
      // --- EMPLOYEES ---
      match /employees/{userId} {
        allow read: if isAuthenticated() && (belongsToOrg(orgId) || isSuperAdmin());
        allow write: if isAuthenticated() && (isOrgAdmin(orgId) || isSuperAdmin() || request.auth.uid == userId);
        
        // --- LEARNING DATA ---
        match /learning/{document=**} {
          allow read: if isAuthenticated() && (belongsToOrg(orgId) || isSuperAdmin() || request.auth.uid == userId);
          allow write: if isAuthenticated() && (isOrgAdmin(orgId) || isSuperAdmin() || request.auth.uid == userId);
        }
      }
      
      // --- PROGRAMS ---
      match /programs/{programId} {
        allow read: if isAuthenticated() && (belongsToOrg(orgId) || isSuperAdmin());
        allow write: if isAuthenticated() && (isOrgAdmin(orgId) || isSuperAdmin());
        
        match /{document=**} {
          allow read: if isAuthenticated() && (belongsToOrg(orgId) || isSuperAdmin());
          allow write: if isAuthenticated() && (isOrgAdmin(orgId) || isSuperAdmin());
        }
      }
      
      // --- CATEGORIES ---
      match /categories/{categoryId} {
        allow read: if isAuthenticated() && (belongsToOrg(orgId) || isSuperAdmin());
        allow write: if isAuthenticated() && (isOrgAdmin(orgId) || isSuperAdmin());
      }
    }
    
    // ========================================
    // LEGACY - Users (pour migration)
    // ========================================
    match /users/{userId} {
      allow read, write: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
      
      match /{document=**} {
        allow read, write: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
      }
    }
    
    // ========================================
    // LEGACY - Programs (pour migration)
    // ========================================
    match /programs/{programId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isSuperAdmin();
      
      match /{document=**} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && isSuperAdmin();
      }
    }
    
    // ========================================
    // LEGACY - Categories (pour migration)
    // ========================================
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isSuperAdmin();
    }
    
    // ========================================
    // LEGACY - Quiz Attempts (pour migration)
    // ========================================
    match /quizAttempts/{attemptId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ========================================
    // LEGACY - Evaluations (pour migration)
    // ========================================
    match /evaluations/{evaluationId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isSuperAdmin();
    }
    
    // ========================================
    // LEGACY - User Evaluation Attempts (pour migration)
    // ========================================
    match /userEvaluationAttempts/{attemptId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ========================================
    // LEGACY - User Progress (pour migration)
    // ========================================
    match /userProgress/{progressId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ========================================
    // LEGACY - AI Exercises (pour migration)
    // ========================================
    match /aiExercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isSuperAdmin();
    }
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/platformAdmins/$(request.auth.uid));
    }
    
    function belongsToOrg(orgId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/employees/$(request.auth.uid));
    }
    
    function isOrgAdmin(orgId) {
      let employee = get(/databases/$(database)/documents/organizations/$(orgId)/employees/$(request.auth.uid));
      return employee != null && employee.data.profile.role == 'admin';
    }
    
    */
  }
}
